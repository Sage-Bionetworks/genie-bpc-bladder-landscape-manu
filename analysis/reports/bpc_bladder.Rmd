---
title: "GENIE BPC Bladder"
author: "Alex Paynter"
date: "May 2023"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: paper
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, include = F,
                      warning = F, message = F,
                      fig.width = 7, fig.height = 5)
k_dpi <- 150
```


<style type="text/css">
.main-container {
  max-width: 1000px !important;
  margin: auto;
}
</style>



```{r}
library(cli)
library(readr)
library(here)
library(dplyr)
library(tidyr)
library(purrr)
library(rlang)
library(magrittr)
library(janitor)
library(stringr)
library(vctrs)
library(glue)

library(ggplot2)
library(ggrepel)
library(ggtext)

library(gt)
library(gtsummary)
library(sunburstR)
library(huxtable)


as_list(here("R", dir(here("R"))))

# Source everything in the "R" folder - just functions, no scripts.
purrr::walk(.x = here("R", dir(here("R"))), .f = source)
```


```{r, set_gtsummary_theme}
theme_gtsummary_compact(font_size = 12)
# A bit of a hack:  I don't want commas in my years.  As it happens,
#   I don't have any numbers bigger than 1000 otherwise, so I'm 
#   just making a global change.
theme_gtsummary_language("en", big.mark = "") 
```


```{r, warning = T}
read_wrap <- function(p) {
  read_csv(file = here("data-raw", p), show_col_types = F)
}

dft_pt <- read_wrap("patient_level_dataset.csv")
dft_ca_ind <- read_wrap("cancer_level_dataset_index.csv")
dft_img <- read_wrap("imaging_level_dataset.csv")
dft_med_onc <- read_wrap("med_onc_note_level_dataset.csv")
dft_path <- read_wrap("pathology_report_level_dataset.csv")
dft_reg <- read_wrap("regimen_cancer_level_dataset.csv")
# dft_tm <- read_wrap("tm_level_dataset.csv")
dft_cpt <- read_wrap("cancer_panel_test_level_dataset.csv")

# generally we'll just be interested in regimens associated with the index ca
dft_reg <- inner_join(
  dft_reg,
  select(dft_ca_ind, record_id, ca_seq),
  by = c("record_id", "ca_seq")
)

# A few sanity checks on the data:
if ((dft_pt$record_id %>% duplicated %>% any)) {
  stop("Duplicated records in patient level dataset.")
}
# At the time we started working there was only one index cancer per
#  record id.  Double checking this as we go:
if ((dft_ca_ind %>% 
     count(record_id, ca_seq, sort = T) %>%
     pull(n) %>% is_greater_than(1) %>% any)) {
  stop("Some patients have >1 index cancer - adjust as needed.")
}
```

```{r, load_derived_data}
dft_drug <- read_csv(file = here("data", 'drug.csv'))
# The drug data is already filtered down to index cancer cases. 
# We don't have do the step done for regimens above.
```


```{r, demo_data_manipulation, include = F}
dft_pt_baseline_sub <- dft_pt %>%
  mutate(
    `Race (primary)` = format_ptlevel_naaccr_race_code_primary(
      naaccr_race_code_primary
    ),
    `Ethnicity` = format_ptlevel_naaccr_ethnicity_code(
      naaccr_ethnicity_code,
    ),
    `Sex at birth` = factor(naaccr_sex_code)
  ) %>%
  select(record_id, 
         Institution = institution,
         `Race (primary)`,
         `Ethnicity`,
         `Sex at birth`,
         birth_year)

dft_ca_ind_baseline_sub <- dft_ca_ind %>%
  mutate(
    ca_dx_how = format_ca_dx_how(ca_dx_how),
    ca_hist_adeno_squamous = format_ca_hist_adeno_squamous(ca_hist_adeno_squamous),
    stage_dx = format_stage_dx(stage_dx),
    ca_path_n_stage = format_ca_path_n_stage(ca_path_n_stage)
  ) %>%
  select(
    record_id,
    `Age at dx (years)` = dob_ca_dx_yrs,
    `Stage at dx` = stage_dx,
    `Source of dx` = ca_dx_how,
    # Update May 5:  Removed histology (unimportant)
    # `Histology` = ca_hist_adeno_squamous, # at dx?
    `Pathologic N Stage` = ca_path_n_stage # describes spread to lymph nodes
  ) 

dft_med_onc_dx <- dft_med_onc %>%
  filter(md_ecog != "Not documented in note") %>%
  mutate(md_ecog = format_md_ecog(md_ecog)) %>%
  filter(dx_md_visit_days < 30 & dx_md_visit_days > -180) %>%
  mutate(abs_days = abs(dx_md_visit_days)) %>%
  arrange(abs_days) %>% 
  select(record_id, `ECOG (med oncologist)` =  md_ecog)


dft_demo <- full_join(
  dft_pt_baseline_sub,
  dft_ca_ind_baseline_sub,
  by = "record_id"
) %>%
  full_join(
    .,
    dft_med_onc_dx,
    by = "record_id"
  )


# age_dx is not an integer in this cohort, so this should be more exact.
dft_demo %<>% 
  mutate(
    `Year of birth` = birth_year,
    `Year of diagnosis` = round(birth_year + `Age at dx (years)`)
  ) %>%
  select(-birth_year) %>%
  relocate(`Year of birth`, `Year of diagnosis`,
           .before = `Age at dx (years)`) 
```


## Content

### R1.1a: Characteristics at dx

In the following table ECOG scores are only reported if captured near diagnosis/baseline.  I defined this (arbitrarily) as any measurement between 180 days before and 30 days after diagnosis.  Importantly, this leaves the majority of the cohort unobserved at baseline.

```{r, tab_r1_1a, include = T}
dft_demo %>%
  select(-record_id) %>%
  gtsummary::tbl_summary(
    data = .,
    digits = list(
      `Year of birth` ~ 0,
      `Year of diagnosis` ~ 0
    )
  ) 
```

### R1.1b: Characteristics at dx (by site)

```{r, tab_r1_1b, include = T}
dft_demo %>%
  select(-record_id) %>%
  gtsummary::tbl_summary(
    data = ., 
    digits = list(
      `Year of birth` ~ 0,
      `Year of diagnosis` ~ 0
    ),
    by = Institution
  ) 
```

### R1.2: Characteristics at metastasis





```{r}
# Gather up a dataframe of key event timing.  Starting with the anything goes setting (i.e. not limited to metastatic disease).
dft_timing <- get_first_cpt(dft_ca_ind, dft_cpt)
```

### R1.3: Timing of key events









```{r}
dft_count_all <- make_obs_count_df(
  med_onc_dat = dft_med_onc,
  img_dat = dft_img,
  reg_dat = dft_reg,
  ca_ind_dat = dft_ca_ind
)

obs_type_levs <- c("Med Onc Notes",
                   "Regimens",
                   "Total Scans",
                   "CT Scan",
                   "MRI Scan",
                   "PET or PET-CT")
                   
dft_count_long <- dft_count_all %>%
  select(record_id, 
         n_med_onc, 
         n_scan_ct, 
         n_scan_mri, 
         n_scan_pet_or_pet_ct,
         n_scan_total,
         n_regimens) %>%
  pivot_longer(cols = -record_id,
               names_to = "type",
               values_to = "n") %>%
  mutate(
    type_f = case_when(
      type %in% "n_med_onc" ~ obs_type_levs[1],
      type %in% "n_regimens" ~ obs_type_levs[2],
      type %in% "n_scan_total" ~ obs_type_levs[3],
      type %in% "n_scan_ct" ~ obs_type_levs[4],
      type %in% "n_scan_mri" ~ obs_type_levs[5],
      type %in% "n_scan_pet_or_pet_ct" ~ obs_type_levs[6]
    ),
    type_f = factor(type_f, levels = obs_type_levs)
  )

dft_count_quantiles <- dft_count_long %>%
  nest(.by = type_f) %>%
  mutate(res = purrr::map(.f = get_quantile_df,
                          .x = data,
                          var = "n")
  ) %>%
  select(type_f, res) %>%
  unnest(res) 

gg_count_ecdf <- ggplot(data = dft_count_long,
                        aes(x = n)) + 
  stat_ecdf(color = '#4477AA') + 
  geom_text_repel(data = dft_count_quantiles,
                  # yes, this is screwed up:
                  aes(x = y, y = n, label = y),
                  hjust = 0, nudge_x = 8, size = 2.5,
                  direction = "x",
                  segment.size = 0.15
  ) + 
  theme_bw() +
  facet_wrap(vars(type_f), scales = "free", nrow = 2) + 
  scale_y_continuous(
    name = "Cohort fraction",
    breaks = c(0, .5, 1),
    labels = paste0(c(0, .5, 1)*100, "%")
  ) + 
  theme(
    strip.text = element_text(hjust = 0)
  )


gg_count_hist_quan <- plot_count_hist_quan(
  dat = dft_count_long,
)



```

### R1.4a: Observations, histogram

The following plot shows the number of people with X observations in our cohort.  The regimens are limited to only those for the index cancer (the other types of observations have no such designation).

```{r, print_count_hist, include = T}
gg_count_hist_quan
```

### R1.4b: Observations, eCDF

Histograms are likely to be better understood by our clinical audience.  The following empirical cumulative distribution plot shows the same data in a way which might be appreciated by readers with computational backgrounds.  We probably don't need both:

```{r, print_count_ecdf, include = T}
gg_count_ecdf
```






```{r create_count_table, include = F}
dfp_obs_count <- dft_count_all %>%
  select(
    Regimens = n_regimens,
    `MedOnc Notes` = n_med_onc,
    `CT` = n_scan_ct,
    `MRI` = n_scan_mri,
    `Bone Scans` = n_scan_bone,
    `PET or PET-CT` = n_scan_pet_or_pet_ct,
    `Total scans` = n_scan_total
  ) %>% 
  gtsummary::tbl_summary(data = ., digits = everything() ~ 0) %>%
  modify_header(
    label = '**Observation Type**'
  )
```

### R1.4c: Observations, table

```{r, include = T}
dfp_obs_count
```








```{r}
dft_drug %>% 
  count(record_id, drug, sort = T) %>%
  count(drug)

dft_top_drugs <- dft_drug %>% 
  count(record_id, drug, sort = T) %>%
  count(drug) %>%
  arrange(desc(n)) %>%
  head(10)

dft_top_drugs %<>%
  mutate(drug = str_replace(drug, "\\(.*\\)", ""))

n_bladder_cohort <- dft_ca_ind %>% nrow()

set.seed(3890)
gg_top_drugs <- dft_top_drugs %>%
  select(drug, n) %>%
  mutate(
    prop = n/n_bladder_cohort,
    str = glue("n={n} ({formatC(prop*100, digits = 1, format = 'f')}%)")
  ) %>%
  mutate(drug = forcats::fct_inorder(drug)) %>%
  ggplot(data = .,
         aes(x = prop, y = drug, fill = drug)) +
  geom_col() + 
  annotate(
    geom = 'rect', 
    xmin = 1, xmax = 1.5, ymin = -2, ymax = 15,
    color = "gray80", fill = "gray80"
  ) + 
  geom_text(size = 2.5, 
            nudge_x = .05, 
            hjust = 0, 
            aes(label = str)) + 
  scale_fill_manual(
    values = sample(make_sun_pal(10))
  ) + 
  scale_x_continuous(
    name = "Proportion of cohort",
    breaks = seq(0, 1, by = .2),
    labels = paste(seq(0, 1, by = .2)*100, "%"),
    expand = expansion(mult = c(0,0), add = c(0,0))
  ) + 
  scale_y_discrete(limits = rev) + 
  coord_cartesian(xlim = c(0,1), ylim = c(0.9, 10.1)) + 
  theme_bw() +
  theme(
    axis.title.y = element_blank(),
    legend.position = "none",
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    plot.margin = unit(c(5,15,5,5), "pt")
  )
  
```

### R2.1a: Drug regimens

The following table shows the proportion of participants who were exposed to each drug at any time during followup.  Only regimens associated with the index cancer are considered, and only the top 10 most used drugs are shown.

```{r, output_top_drug_plot, include = T, fig.height = 3, fig.width = 7}
gg_top_drugs
```





```{r}
dft_sun_reg_all <- make_sunburst_input(
  dat = dft_reg,
  var = "regimen_drugs",
  order_var = "regimen_number",
  max_depth = 3
)
```

### R2.2: Drug regimens (sunburst)

The following plot shows the regimens used by the cohort which were associated with an index cancer.  The innermost ring is the first drug regimen reported after diagnosis.  The second ring shows the second drug regimen used after diagnosis, etc.

```{r, include = T}
sun_wrap(dft_sun_reg_all, seed = 238)
```

Places to go from here to get a more tractable display:

- Categorize the drugs into a few categories.
- Look at the ordering of specific drugs of interest.
- Examine the drugs used on/after an event of interest (distant metastasis, for example).



## Notes

### Bladder specific variables (analysis TBD)

Titles copied from data guide or abbreviated from there:

- Pathology Report With Indication That Bladder Cancer Invades the Muscularis Propria (Yes/no//unknown)
- Muscularis propria invasion by specimen.
- Medical Oncologist Assessment of Eastern Cooperative Oncology Group (ECOG) Performance Status
  - That is - other times of interest?  Show by stage?
- Medical Oncologist Assessment of Karnofsky Performance Status

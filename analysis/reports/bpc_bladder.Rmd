---
title: "GENIE BPC Bladder"
author: "Alex Paynter"
date: "May 2023"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: paper
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, include = F,
                      warning = F, message = F,
                      fig.width = 7, fig.height = 5)
k_dpi <- 150
```


<style type="text/css">
.main-container {
  max-width: 1000px !important;
  margin: auto;
}
</style>



```{r}
library(cli)
library(readr)
library(here)
library(dplyr)
library(tidyr)
library(purrr)
library(rlang)
library(magrittr)
library(janitor)
library(stringr)
library(vctrs)
library(glue)

library(ggplot2)
library(ggrepel)

library(gt)
library(gtsummary)
library(sunburstR)
library(huxtable)


as_list(here("R", dir(here("R"))))

# Source everything in the "R" folder - just functions, no scripts.
purrr::walk(.x = here("R", dir(here("R"))), .f = source)
```


```{r, set_gtsummary_theme}
theme_gtsummary_compact(font_size = 10)
```


```{r, warning = T}
read_wrap <- function(p) {
  read_csv(file = here("data-raw", p), show_col_types = F)
}

dft_pt <- read_wrap("patient_level_dataset.csv")
dft_ca_ind <- read_wrap("cancer_level_dataset_index.csv")
dft_img <- read_wrap("imaging_level_dataset.csv")
dft_med_onc <- read_wrap("med_onc_note_level_dataset.csv")
dft_path <- read_wrap("pathology_report_level_dataset.csv")
dft_reg <- read_wrap("regimen_cancer_level_dataset.csv")
# dft_tm <- read_wrap("tm_level_dataset.csv")
dft_cpt <- read_wrap("cancer_panel_test_level_dataset.csv")

# generally we'll just be interested in regimens associated with the index ca
dft_reg <- inner_join(
  dft_reg,
  select(dft_ca_ind, record_id, ca_seq),
  by = c("record_id", "ca_seq")
)

# A few sanity checks on the data:
if ((dft_pt$record_id %>% duplicated %>% any)) {
  stop("Duplicated records in patient level dataset.")
}
# At the time we started working there was only one index cancer per
#  record id.  Double checking this as we go:
if ((dft_ca_ind %>% 
     count(record_id, ca_seq, sort = T) %>%
     pull(n) %>% is_greater_than(1) %>% any)) {
  stop("Some patients have >1 index cancer - adjust as needed.")
}
```

```{r, load_derived_data}
dft_drug <- read_csv(file = here("data", 'drug.csv'))
# The drug data is already filtered down to index cancer cases. 
# We don't have do the step done for regimens above.
```


```{r, demo_data_manipulation, include = F}
dft_pt_baseline_sub <- dft_pt %>%
  mutate(
    `Race (primary)` = format_ptlevel_naaccr_race_code_primary(
      naaccr_race_code_primary
    ),
    `Ethnicity` = format_ptlevel_naaccr_ethnicity_code(
      naaccr_ethnicity_code,
    ),
    `Sex at birth` = factor(naaccr_sex_code)
  ) %>%
  select(record_id, 
         Institution = institution,
         `Race (primary)`,
         `Ethnicity`,
         `Sex at birth`)

dft_ca_ind_baseline_sub <- dft_ca_ind %>%
  mutate(
    ca_dx_how = format_ca_dx_how(ca_dx_how),
    ca_hist_adeno_squamous = format_ca_hist_adeno_squamous(ca_hist_adeno_squamous),
    stage_dx = format_stage_dx(stage_dx),
    ca_path_n_stage = format_ca_path_n_stage(ca_path_n_stage)
  ) %>%
  select(
    record_id,
    `Age at dx (years)` = dob_ca_dx_yrs,
    `Stage at dx` = stage_dx,
    `Source of dx` = ca_dx_how,
    # Update May 5:  Removed histology (unimportant)
    # `Histology` = ca_hist_adeno_squamous, # at dx?
    `Pathologic N Stage` = ca_path_n_stage # describes spread to lymph nodes
  ) 

dft_med_onc_dx <- dft_med_onc %>%
  filter(md_ecog != "Not documented in note") %>%
  mutate(md_ecog = format_md_ecog(md_ecog)) %>%
  filter(dx_md_visit_days < 30 & dx_md_visit_days > -180) %>%
  mutate(abs_days = abs(dx_md_visit_days)) %>%
  arrange(abs_days) %>% 
  select(record_id, `ECOG (med oncologist)` =  md_ecog)


dft_demo <- full_join(
  dft_pt_baseline_sub,
  dft_ca_ind_baseline_sub,
  by = "record_id"
) %>%
  full_join(
    .,
    dft_med_onc_dx,
    by = "record_id"
  )
```


## Content

### Characteristics at dx

In the following table ECOG scores are only reported if captured near diagnosis/baseline.  I defined this (arbitrarily) as any measurement between 180 days before and 30 days after diagnosis.  Importantly, this leaves the majority of the cohort unobserved at baseline.

```{r, tab_r1_1a, include = T}
dft_demo %>%
  select(-record_id) %>%
  gtsummary::tbl_summary(data = .) 
```

### Characteristics at dx (by site)

```{r, tab_r1_1b, include = T}
dft_demo %>%
  select(-record_id) %>%
  gtsummary::tbl_summary(data = ., by = Institution) 
```



```{r}
dft_drug %>% 
  count(record_id, drug, sort = T) %>%
  count(drug)

dft_top_drugs <- dft_drug %>% 
  count(record_id, drug, sort = T) %>%
  count(drug) %>%
  arrange(desc(n)) %>%
  head(10)

dft_top_drugs %<>%
  mutate(drug = str_replace(drug, "\\(.*\\)", ""))

n_bladder_cohort <- dft_ca_ind %>% nrow()

set.seed(3890)
gg_top_drugs <- dft_top_drugs %>%
  select(drug, n) %>%
  mutate(
    prop = n/n_bladder_cohort,
    str = glue("n={n} ({formatC(prop*100, digits = 1, format = 'f')}%)")
  ) %>%
  mutate(drug = forcats::fct_inorder(drug)) %>%
  ggplot(data = .,
         aes(x = prop, y = drug, fill = drug)) +
  geom_col() + 
  annotate(
    geom = 'rect', 
    xmin = 1, xmax = 1.5, ymin = -2, ymax = 15,
    color = "gray80", fill = "gray80"
  ) + 
  geom_text(size = 2.5, 
            nudge_x = .05, 
            hjust = 0, 
            aes(label = str)) + 
  scale_fill_manual(
    values = sample(make_sun_pal(10))
  ) + 
  scale_x_continuous(
    name = "Proportion of cohort",
    breaks = seq(0, 1, by = .2),
    labels = paste(seq(0, 1, by = .2)*100, "%"),
    expand = expansion(mult = c(0,0), add = c(0,0))
  ) + 
  scale_y_discrete(limits = rev) + 
  coord_cartesian(xlim = c(0,1), ylim = c(0.9, 10.1)) + 
  theme_bw() +
  theme(
    axis.title.y = element_blank(),
    legend.position = "none",
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    plot.margin = unit(c(5,15,5,5), "pt")
  )
  
```

### Drug regimens

The following table shows the proportion of participants who were exposed to each drug at any time during followup.  Only regimens associated with the index cancer are considered, and only the top 10 most used drugs are shown.

```{r, output_top_drug_plot, include = T, fig.height = 3, fig.width = 7}
gg_top_drugs
```





```{r}
dft_sun_reg_all <- make_sunburst_input(
  dat = dft_reg,
  var = "regimen_drugs",
  order_var = "regimen_number",
  max_depth = 3
)
```

### Drug regimens (sunburst)

The following plot shows the regimens used by the cohort which were associated with an index cancer.  The innermost ring is the first drug regimen reported after diagnosis.  The second ring shows the second drug regimen used after diagnosis, etc.

```{r, include = T}
sun_wrap(dft_sun_reg_all, seed = 238)
```

Places to go from here to get a more tractable display:

- Categorize the drugs into a few categories.
- Look at the ordering of specific drugs of interest.
- Examine the drugs used on/after an event of interest (distant metastasis, for example).


### Bladder specific variables (analysis TBD)

Titles copied from data guide or abbreviated from there:

- Pathology Report With Indication That Bladder Cancer Invades the Muscularis Propria (Yes/no//unknown)
- Muscularis propria invasion by specimen.
- Medical Oncologist Assessment of Eastern Cooperative Oncology Group (ECOG) Performance Status
  - That is - other times of interest?  Show by stage?
- Medical Oncologist Assessment of Karnofsky Performance Status

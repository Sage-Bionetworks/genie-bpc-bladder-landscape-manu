---
title: "GENIE BPC Bladder"
author: "Alex Paynter"
date: "May 2023"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: paper
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, include = F,
                      warning = F, message = F,
                      fig.width = 7, fig.height = 5)
k_dpi <- 150
```


<style type="text/css">
.main-container {
  max-width: 1000px !important;
  margin: auto;
}
</style>



```{r}
library(purrr); library(fs); library(here);
purrr::walk(.x = fs::dir_ls(here('R')), .f = source)
```


```{r, set_gtsummary_theme}
theme_gtsummary_compact(font_size = 12)
theme_gtsummary_language("en", big.mark = "") 
```


```{r, warning = T}
read_wrap <- function(p) {
  read_rds(
    file = here("data", 'cohort', paste0(p, '.rds'))
  )
}

dft_pt <- read_wrap("pt")
dft_ca_ind <- read_wrap("ca_ind")
dft_img <- read_wrap("img")
dft_med_onc <- read_wrap("med_onc")
dft_path <- read_wrap("path")
dft_reg <- read_wrap("reg")
# dft_tm <- read_wrap("tm_level_dataset.csv")
dft_cpt <- read_wrap("cpt")

```

```{r, load_derived_data}
dft_drug <- read_rds(file = here("data", 'cohort', 'drug.rds'))
# The drug data is already filtered down to index cancer cases. 
# We don't have do the step done for regimens above.

read_wrap_dmet <- read_wrap <- function(p) {
  read_rds(
    file = here("data", 'dmet', p)
  )
}

dft_pt_dmet <- read_wrap_dmet("pt_dmet.rds")
dft_ca_ind_dmet <- read_wrap_dmet("ca_ind_dmet.rds")
dft_reg_dmet_s <- read_wrap_dmet("reg_start_gte_dmet.rds")
```


```{r, demo_data_manipulation, include = F}
dft_pt_baseline_sub <- dft_pt %>%
  mutate(
    `Race (primary)` = format_ptlevel_naaccr_race_code_primary(
      naaccr_race_code_primary
    ),
    `Ethnicity` = format_ptlevel_naaccr_ethnicity_code(
      naaccr_ethnicity_code,
    ),
    `Sex at birth` = factor(naaccr_sex_code)
  ) %>%
  select(record_id, 
         Institution = institution,
         `Race (primary)`,
         `Ethnicity`,
         `Sex at birth`,
         birth_year)

dft_ca_ind_baseline_sub <- dft_ca_ind %>%
  mutate(
    ca_dx_how = format_ca_dx_how(ca_dx_how),
    ca_hist_adeno_squamous = format_ca_hist_adeno_squamous(ca_hist_adeno_squamous),
    stage_dx = format_stage_dx(stage_dx),
    ca_path_n_stage = format_ca_path_n_stage(ca_path_n_stage)
  ) %>%
  select(
    record_id,
    `Age at dx (years)` = dob_ca_dx_yrs,
    `Stage at dx` = stage_dx,
    `Source of dx` = ca_dx_how,
    # Update May 5:  Removed histology (unimportant)
    # `Histology` = ca_hist_adeno_squamous, # at dx?
    `Pathologic N Stage` = ca_path_n_stage # describes spread to lymph nodes
  ) 

dft_med_onc_dx <- augment_med_onc_imputed_ecog(dft_med_onc)

dft_med_onc_dx %<>%
  filter(md_ecog_imputed != "Not documented in note") %>%
  mutate(md_ecog_imputed = format_md_ecog(md_ecog_imputed)) %>%
  group_by(record_id) %>%
  filter(dx_md_visit_days < 30 & dx_md_visit_days > -180) %>%
  mutate(abs_days = abs(dx_md_visit_days)) %>%
  arrange(abs_days) %>% 
  slice(1) %>%
  ungroup(.) %>%
  select(
    record_id, 
    `ECOG (or Karnofsky)` =  md_ecog_imputed,
    `ECOG scale source` = md_ecog_imp_source,
  )

dft_demo <- full_join(
  dft_pt_baseline_sub,
  dft_ca_ind_baseline_sub,
  by = "record_id"
) %>%
  full_join(
    .,
    dft_med_onc_dx,
    by = "record_id"
  )


# age_dx is not an integer in this cohort, so this should be more exact.
dft_demo %<>% 
  mutate(
    `Year of birth` = birth_year,
    `Year of diagnosis` = round(birth_year + `Age at dx (years)`)
  ) %>%
  select(-birth_year) %>%
  relocate(`Year of birth`, `Year of diagnosis`,
           .before = `Age at dx (years)`) 
```


## Content

### *R1.1a: Characteristics at dx

Table of characteristics at diagnosis.  A few notes:

- If Karnofsky scale is reported, we convert that to ECOG and use it in this table.
- ECOG scores are only reported if captured near diagnosis/baseline.  I defined this (arbitrarily) as any measurement up to 180 days before and 30 days after diagnosis.  

```{r, tab_r1_1a, include = T}
dft_demo %>%
  select(-record_id) %>%
  gtsummary::tbl_summary(
    data = .,
    digits = list(
      `Year of birth` ~ 0,
      `Year of diagnosis` ~ 0
    )
  ) 
```

### *R1.1b: Characteristics at dx (by site)

The previous table, broken down by site.

```{r, tab_r1_1b, include = T}
dft_demo %>%
  select(-record_id) %>%
  gtsummary::tbl_summary(
    data = ., 
    digits = list(
      `Year of birth` ~ 0,
      `Year of diagnosis` ~ 0
    ),
    by = Institution
  ) 
```

**Observation:** The only site with KPS scores available to convert to ECOG was MSK.  While this table only shows information near diagnosis, this is generally the case that MSK is the only site with subtantial KPS reporting.

### R1.2: Characteristics at metastasis

**Placeholder.**  Most of the information requested here is covered in the plots below.




```{r}
dft_timing <- make_grand_timing_df(
  pt_dat = dft_pt,
  ca_ind_dat = dft_ca_ind,
  cpt_dat = dft_cpt,
  reg_dat = dft_reg
)

dft_timing %<>% 
  mutate(tt_seq_first_reg_yrs = tt_seq_dx_yrs - tt_first_reg_dx_yrs)

dft_timing_long <- dft_timing %>% 
  select(record_id, ca_seq, matches("^tt_")) %>%
  select(-tt_dx_dob_yrs) %>%
  pivot_longer(
    cols = matches("^tt_"),
    names_to = "interval",
    values_to = "years"
  ) %>%
  mutate(
    interval = beautify_strings(interval, 
                                dict = dict_timing_vars)) 

vec_origin_levs <- c("Diagnosis", "First Regimen", "Metastasis")

dft_timing_long %<>% 
  mutate(
    origin = case_when(
      str_detect(interval, "\\(from dx\\)$") ~ vec_origin_levs[1],
      str_detect(interval, "\\(from first regimen\\)$") ~ vec_origin_levs[2],
      str_detect(interval, "\\(from dmet\\)$") ~ vec_origin_levs[3],
    ),
    origin = factor(origin, levels = vec_origin_levs)
  )

gg_timing_dist_all <- plot_timing_intervals(dat = dft_timing_long)

gg_timing_ecdf_all <- plot_timing_ecdf(dft_timing_long)

gg_timing_comb_all <- cowplot::plot_grid(
  (gg_timing_dist_all + labs(title = "Density")),
  (gg_timing_ecdf_all + labs(title = "eCDF")),
  nrow = 1,
  rel_widths = c(0.7, 0.3)
)

```
  
### *R1.3a: Event timing (whole cohort)

The following plots show five time intervals in the entire cohort:

1. Time (years) from diagnosis to the start of the first regimen.
2. Time (years) from diagnosis to the first next generation sequencing test **report date**.
3. Time (years) from first regimen to the first NGS report date.
4. Time (years) from diagnosis to the first note of distant metastasis.  For those diagnosed at Stage IV, this implies a time of zero years.
5. Time (years) that the participant was followed for survival.  Follow-up ends with censoring or death.

On the left violin plots are shown, which approximate the density of observations (similar to a histogram).  Summary statistics are also shown in the top right of these plots.  At right, similar information is shown in an empirical cumulative distribution plot.  An eCDF shows the proportion of the cohort (Y) with a value less than or equal to each duration in years (X).

```{r, include = T, fig.height = 7.5}
gg_timing_comb_all
```





```{r}
# Here we'll use the dmet filtered data for everything except for 
#   the NGS test.  That is, only regimens which were started after
#   distant metastasis, only people who had dmet, etc.
dft_timing_dmet <- make_grand_timing_df_dmet(
  pt_dat = dft_pt_dmet,
  ca_ind_dat = dft_ca_ind_dmet,
  cpt_dat = dft_cpt,
  reg_dat = dft_reg_dmet_s
)

dft_timing_dmet_long <- dft_timing_dmet %>% 
  select(record_id, ca_seq, matches("^tt_")) %>%
  select(-tt_dmet_dob_yrs) %>%
  pivot_longer(
    cols = matches("^tt_"),
    names_to = "interval",
    values_to = "years"
  ) %>%
  mutate(
    interval = beautify_strings(
      interval, 
      dict = dict_timing_vars_dmet
    )
  ) 

vec_origin_levs <- c("Diagnosis", "First Regimen", "Metastasis")

dft_timing_dmet_long %<>% 
  mutate(
    origin = case_when(
      str_detect(interval, "\\(from dx\\)$") ~ vec_origin_levs[1],
      str_detect(interval, "\\(from first regimen\\)$") ~ vec_origin_levs[2],
      str_detect(interval, "\\(from dmet\\)$") ~ vec_origin_levs[3],
    ),
    origin = factor(origin, levels = vec_origin_levs)
  )

gg_timing_dmet_dist_all <- plot_timing_intervals(dat = dft_timing_dmet_long) 
gg_timing_dmet_ecdf_all <- plot_timing_ecdf(dft_timing_dmet_long)

gg_timing_dmet_comb_all <- cowplot::plot_grid(
  (gg_timing_dmet_dist_all + labs(title = "Density")),
  (gg_timing_dmet_ecdf_all + labs(title = "eCDF")),
  nrow = 1,
  rel_widths = c(0.7, 0.3)
)
```



### *R1.3b: Event timing (from dmet)

The following plot is similar to the previous, except that times are indexed from the diagnosis of distant metastasis.  The cohort includes only those who were diagnosed with a metastasis at some point in followup.  These are the events shown:

1. First NGS report date relative to the diagnosis of distant metastasis (years).
2. First **post-metastasis** regimen start date, relative to the diagnosis of distant metastasis.  To be clear, regimens continued into the metastatic state are not counted here (open to change on this).
3. Progression or censoring time relative to distant metastasis diagnosis.
4. Survival or censoring time relative to distant metastasis.

```{r, print_dmet_event_timing, include = T, fig.height = 6}
gg_timing_dmet_comb_all
```






```{r}
dft_count_all <- make_obs_count_df(
  med_onc_dat = dft_med_onc,
  img_dat = dft_img,
  reg_dat = dft_reg,
  ca_ind_dat = dft_ca_ind
)

obs_type_levs <- c("Med Onc Notes",
                   "Regimens",
                   "Total Scans",
                   "CT Scan",
                   "MRI Scan",
                   "PET or PET-CT")
                   
dft_count_long <- dft_count_all %>%
  select(record_id, 
         n_med_onc, 
         n_scan_ct, 
         n_scan_mri, 
         n_scan_pet_or_pet_ct,
         n_scan_total,
         n_regimens) %>%
  pivot_longer(cols = -record_id,
               names_to = "type",
               values_to = "n") %>%
  mutate(
    type_f = case_when(
      type %in% "n_med_onc" ~ obs_type_levs[1],
      type %in% "n_regimens" ~ obs_type_levs[2],
      type %in% "n_scan_total" ~ obs_type_levs[3],
      type %in% "n_scan_ct" ~ obs_type_levs[4],
      type %in% "n_scan_mri" ~ obs_type_levs[5],
      type %in% "n_scan_pet_or_pet_ct" ~ obs_type_levs[6]
    ),
    type_f = factor(type_f, levels = obs_type_levs)
  )

dft_count_quantiles <- dft_count_long %>%
  nest(.by = type_f) %>%
  mutate(res = purrr::map(.f = get_quantile_df,
                          .x = data,
                          var = "n")
  ) %>%
  select(type_f, res) %>%
  unnest(res) 

gg_count_ecdf <- ggplot(data = dft_count_long,
                        aes(x = n)) + 
  stat_ecdf(color = '#4477AA') + 
  geom_text_repel(data = dft_count_quantiles,
                  # yes, this is screwed up:
                  aes(x = y, y = n, label = y),
                  hjust = 0, nudge_x = 8, size = 2.5,
                  direction = "x",
                  segment.size = 0.15
  ) + 
  theme_bw() +
  facet_wrap(vars(type_f), scales = "free", nrow = 2) + 
  scale_y_continuous(
    name = "Cohort fraction",
    breaks = c(0, .5, 1),
    labels = paste0(c(0, .5, 1)*100, "%")
  ) + 
  theme(
    strip.text = element_text(hjust = 0)
  )


gg_count_hist_quan <- plot_count_hist_quan(
  dat = dft_count_long,
)



```

### *R1.4a: Observations, histogram

The following plot shows the number of people with X observations in our cohort.  The regimens are limited to only those for the index cancer (the other types of observations have no such designation).

```{r, print_count_hist, include = T}
gg_count_hist_quan
```

### *R1.4b: Observations, eCDF

Histograms are likely to be better understood by our clinical audience.  The following empirical cumulative distribution plot shows the same data in a way which might be appreciated by readers with computational backgrounds.

```{r, print_count_ecdf, include = T}
gg_count_ecdf
```






```{r create_count_table, include = F}
dfp_obs_count <- dft_count_all %>%
  select(
    Regimens = n_regimens,
    `MedOnc Notes` = n_med_onc,
    `CT` = n_scan_ct,
    `MRI` = n_scan_mri,
    `Bone Scans` = n_scan_bone,
    `PET or PET-CT` = n_scan_pet_or_pet_ct,
    `Total scans` = n_scan_total
  ) %>% 
  gtsummary::tbl_summary(data = ., digits = everything() ~ 0) %>%
  modify_header(
    label = '**Observation Type**'
  )
```

### *R1.4c: Observations, table

Simplest representation of the number of observations:  A table with median, first quartile, third quartile.

```{r, include = T}
dfp_obs_count
```








```{r}
set.seed(2398) # color sampling below.

dft_drug %>% 
  count(record_id, drug, sort = T) %>%
  count(drug)

dft_top_drugs <- dft_drug %>% 
  count(record_id, drug, sort = T) %>%
  count(drug) %>%
  arrange(desc(n)) %>%
  head(10)

dft_top_drugs %<>%
  mutate(drug = str_replace(drug, "\\(.*\\)", ""))

n_bladder_cohort <- dft_ca_ind %>% nrow()

gg_top_drugs <- plot_drug_prop(
  drug_dat = dft_top_drugs,
  cohort_n = n_bladder_cohort,
  sample(viridisLite::magma(n = 10, begin = 0.2, end = 0.8)),
  plot_title = glue("Drugs started any time (n={n_bladder_cohort})")
)


# Now repeat the calculation above for CRPC regimens only.

dft_dmet_block <- make_dmet_status_block(dft_ca_ind)
  
n_bladder_dmet <- dft_dmet_block %>% 
  filter(dmet_status %in% "Distant Metastasis") %>%
  nrow

dft_drug_dmet <- dft_dmet_block %>%
  filter(dmet_status %in% "Distant Metastasis") %>%
  mutate(dmet_days = dx_block_start * 365.25) %>%
  select(record_id, dmet_days) %>%
  inner_join(
    dft_drug, 
    ., 
    by = "record_id",
    relationship = "many-to-one"
  )

dft_drug_dmet %<>% 
  # dx_drug_start_int is the number of days from dx to start of drug.
  filter(dx_drug_start_int >= dmet_days)

# Same processing from here:
dfp_top_drugs_dmet <- dft_drug_dmet %>%
  group_by(record_id, drug) %>%
  summarize(observed = 1, .groups = "drop") %>%
  group_by(drug) %>%
  summarize(n = sum(observed)) %>%
  arrange(desc(n)) %>%
  head(10) %>%
  mutate(drug = str_replace(drug, "\\(.*\\)", ""))

gg_top_drugs_dmet <- plot_drug_prop(
  drug_dat = dfp_top_drugs_dmet,
  cohort_n = n_bladder_dmet,
  pal = sample(viridisLite::viridis(n = 10, begin = 0.2, end = 0.8)),
  plot_title = glue("Drugs started in metastatic setting (n={n_bladder_dmet})")
)

gg_top_drug_comb <- cowplot::plot_grid(
  gg_top_drugs, gg_top_drugs_dmet,
  ncol = 1
)




  
```

### *R2.1a: Drug regimens

The following table shows the proportion of participants who were exposed to each drug at any time during followup.  Only regimens associated with the index cancer are considered, and only the top 10 most used drugs are shown.

```{r, output_top_drug_plot, include = T, fig.height = 6, fig.width = 7}
gg_top_drug_comb
```





```{r}
dft_sun_reg_all <- make_sunburst_input(
  dat = dft_reg,
  var = "regimen_drugs",
  order_var = "regimen_number",
  max_depth = 3
)
```

### R2.2a: Drug regimens (sunburst)

The following plot (a "sunburst" plot) shows the regimens used by the cohort which were associated with an index cancer.  The innermost ring is the first drug regimen reported after diagnosis.  The second ring shows the second drug regimen used after diagnosis, etc.

```{r, include = T}
sun_wrap(dft_sun_reg_all, seed = 238)
```

Places to go from here to get a more tractable display:

- Categorize the drugs into a few categories.
- Look at the ordering of specific drugs of interest.
- Examine the drugs used on/after an event of interest (distant metastasis, for example).


```{r}
dft_sun_reg_dmet <- make_sunburst_input(
  dat = dft_reg_dmet_s,
  var = "regimen_drugs",
  order_var = "regimen_number",
  max_depth = 3
)
```


### R2.2b: Drug regimens (metastatic setting)

```{r, include = T}
sun_wrap(dft_sun_reg_dmet, seed = 238)
```



## Notes


### Todos

- Add swimmer plot.



